<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI CV Tailor — MyPerfectCV</title>
  <meta name="description" content="Tailor your CV to any job description using AI in seconds.">
  <link rel="stylesheet" href="style.css">

  <!-- PDF.js & Mammoth for file parsing (client-side) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
  <!-- html2pdf for export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    /* ---- Layout ---- */
    .builder-layout {
      display: flex;
      height: calc(100vh - 64px);
      overflow: hidden;
    }

    /* ---- Sidebar ---- */
    .sidebar {
      width: 360px;
      min-width: 360px;
      background: white;
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .sidebar-header {
      padding: 20px 24px 16px;
      border-bottom: 1px solid var(--border);
      background: var(--primary);
      color: white;
    }
    .sidebar-header h2 {
      font-family: var(--font-display);
      font-size: 1.2rem;
      margin-bottom: 4px;
    }
    .sidebar-header p { font-size: 0.82rem; color: #94a3b8; }

    .step-section {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
    }
    .step-label {
      display: flex; align-items: center; gap: 10px;
      font-size: 0.82rem; font-weight: 700; text-transform: uppercase;
      letter-spacing: 1px; color: var(--text-light); margin-bottom: 12px;
    }
    .step-num {
      width: 22px; height: 22px; border-radius: 50%;
      background: var(--primary); color: white;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.75rem; font-weight: 700; flex-shrink: 0;
    }
    .step-num.done { background: var(--success); }

    /* Upload area */
    .upload-zone {
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      padding: 18px;
      text-align: center;
      cursor: pointer;
      transition: all .18s;
      position: relative;
      overflow: hidden;
    }
    .upload-zone:hover, .upload-zone.drag-over {
      border-color: var(--secondary);
      background: #fff1f3;
    }
    .upload-zone.has-file {
      border-color: var(--success);
      background: #f0fdf4;
      border-style: solid;
    }
    .upload-zone svg { width: 28px; height: 28px; color: var(--text-light); margin-bottom: 8px; }
    .upload-zone.has-file svg { color: var(--success); }
    .upload-zone p { font-size: 0.85rem; color: var(--text-light); margin: 0; }
    .upload-zone .filename { font-weight: 600; color: var(--text); font-size: 0.85rem; }

    /* JD textarea */
    .jd-textarea {
      width: 100%;
      height: 160px;
      padding: 12px;
      border: 1.5px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.85rem;
      resize: vertical;
      font-family: var(--font-body);
      line-height: 1.5;
      transition: border-color .18s;
      background: var(--bg);
    }
    .jd-textarea:focus {
      outline: none;
      border-color: var(--accent);
      background: white;
    }
    .char-count { font-size: 0.75rem; color: var(--text-light); text-align: right; margin-top: 4px; }

    /* API Key input */
    .api-key-wrap {
      position: relative;
    }
    .api-key-input {
      width: 100%;
      padding: 10px 40px 10px 12px;
      border: 1.5px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.85rem;
      font-family: var(--font-body);
      transition: border-color .18s;
    }
    .api-key-input:focus { outline: none; border-color: var(--accent); }
    .api-key-toggle {
      position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
      background: none; border: none; cursor: pointer; color: var(--text-light);
      padding: 2px;
    }
    .api-key-note {
      font-size: 0.75rem; color: var(--text-light); margin-top: 6px;
      display: flex; align-items: flex-start; gap: 5px;
    }
    .api-key-note svg { width: 12px; height: 12px; flex-shrink: 0; margin-top: 2px; }

    /* Generate button */
    .generate-btn {
      width: 100%;
      padding: 13px;
      border: none;
      border-radius: var(--radius);
      font-size: 0.95rem;
      font-weight: 700;
      font-family: var(--font-body);
      cursor: pointer;
      background: linear-gradient(135deg, var(--secondary) 0%, #c23152 100%);
      color: white;
      display: flex; align-items: center; justify-content: center; gap: 8px;
      transition: all .2s;
      position: relative;
      overflow: hidden;
    }
    .generate-btn::before {
      content: '';
      position: absolute; inset: 0;
      background: linear-gradient(135deg, rgba(255,255,255,.15) 0%, transparent 60%);
      opacity: 0; transition: opacity .2s;
    }
    .generate-btn:hover:not(:disabled)::before { opacity: 1; }
    .generate-btn:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(233,69,96,.35); }
    .generate-btn:disabled { opacity: 0.55; cursor: not-allowed; transform: none; box-shadow: none; }

    .status-bar {
      padding: 10px 24px;
      font-size: 0.8rem;
      color: var(--text-light);
      display: flex; align-items: center; gap: 8px;
      min-height: 38px;
    }
    .status-bar .dot {
      width: 7px; height: 7px; border-radius: 50%;
      background: var(--success);
      flex-shrink: 0;
    }
    .status-bar .dot.loading { background: var(--warning); animation: pulse 1s infinite; }
    .status-bar .dot.error { background: var(--secondary); }
    @keyframes pulse { 50% { opacity: .3; } }

    /* Download section */
    .sidebar-footer {
      margin-top: auto;
      padding: 16px 24px;
      border-top: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    /* ---- Main Preview Area ---- */
    .preview-area {
      flex: 1;
      background: #dde3ec;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 32px 24px;
      position: relative;
    }

    /* Score badge */
    .score-badge {
      display: none;
      position: fixed;
      top: 80px; right: 24px;
      background: white;
      border-radius: 12px;
      padding: 10px 18px;
      box-shadow: var(--shadow-md);
      border: 1.5px solid var(--border);
      z-index: 100;
      font-size: 0.85rem;
      font-weight: 600;
      align-items: center;
      gap: 10px;
    }
    .score-badge.visible { display: flex; }
    .score-ring {
      width: 48px; height: 48px; position: relative;
    }
    .score-ring svg { width: 48px; height: 48px; transform: rotate(-90deg); }
    .score-ring .track { fill: none; stroke: var(--bg-alt); stroke-width: 4; }
    .score-ring .fill  { fill: none; stroke: var(--success); stroke-width: 4; stroke-linecap: round; transition: stroke-dashoffset .6s ease; }
    .score-ring .fill.mid { stroke: var(--warning); }
    .score-ring .fill.low { stroke: var(--secondary); }
    .score-ring .label {
      position: absolute; inset: 0;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.7rem; font-weight: 700;
    }
    .score-info { line-height: 1.3; }
    .score-info .score-pct { font-size: 1.1rem; color: var(--text); }
    .score-info .score-sub { font-size: 0.75rem; color: var(--text-light); font-weight: 400; }

    /* Loading overlay */
    .loading-overlay {
      display: none;
      position: absolute; inset: 0;
      background: rgba(221, 227, 236, 0.85);
      backdrop-filter: blur(6px);
      z-index: 50;
      align-items: center; justify-content: center; flex-direction: column;
      gap: 16px;
    }
    .loading-overlay.visible { display: flex; }
    .loading-card {
      background: white; border-radius: 16px; padding: 32px 40px;
      text-align: center; box-shadow: var(--shadow-lg);
      max-width: 300px;
    }
    .loading-card h3 { font-family: var(--font-display); font-size: 1.2rem; margin: 16px 0 6px; }
    .loading-card p { font-size: 0.85rem; color: var(--text-light); }
    .loading-steps {
      margin-top: 16px; text-align: left;
      display: flex; flex-direction: column; gap: 8px;
    }
    .loading-step {
      display: flex; align-items: center; gap: 10px;
      font-size: 0.82rem; color: var(--text-light);
      transition: color .3s;
    }
    .loading-step.active { color: var(--text); font-weight: 600; }
    .loading-step.done { color: var(--success); }
    .loading-step .step-icon { width: 18px; height: 18px; flex-shrink: 0; }

    /* CV wrapper for zoom */
    .cv-wrapper {
      transform-origin: top center;
    }

    /* Empty state */
    .empty-state {
      text-align: center; color: var(--text-light); max-width: 360px;
      padding: 60px 0;
    }
    .empty-state svg { width: 64px; height: 64px; margin-bottom: 16px; opacity: .4; }
    .empty-state h3 { font-family: var(--font-display); font-size: 1.3rem; color: var(--text); margin-bottom: 8px; }
    .empty-state p { font-size: 0.88rem; line-height: 1.6; }

    /* Error banner */
    .error-banner {
      display: none;
      background: #fef2f2; border: 1px solid #fecaca;
      color: #b91c1c; border-radius: var(--radius);
      padding: 10px 14px; font-size: 0.85rem;
      margin: 0 24px 12px;
      align-items: flex-start; gap: 8px;
    }
    .error-banner.visible { display: flex; }
    .error-banner svg { width: 16px; flex-shrink: 0; margin-top: 1px; }

    /* Keyword tags in sidebar */
    .keyword-tags { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px; }
    .kw-tag {
      font-size: 0.75rem; padding: 2px 8px; border-radius: 20px;
      background: var(--bg-alt); color: var(--text-light); border: 1px solid var(--border);
    }
    .kw-tag.match { background: #fef2f2; color: #b91c1c; border-color: #fecaca; font-weight: 600; }

    /* Responsive */
    @media (max-width: 900px) {
      .builder-layout { flex-direction: column; height: auto; overflow: visible; }
      .sidebar { width: 100%; min-width: 0; }
      .preview-area { min-height: 80vh; }
      .cv-wrapper { transform: none !important; }
      .score-badge { top: auto; bottom: 24px; right: 16px; }
    }
  </style>
</head>
<body>

<!-- ===== HEADER ===== -->
<header>
  <div class="header-content">
    <div class="logo" onclick="window.location.href='index.html'">
      <span class="my">My</span><span class="perfect">Perfect</span><span class="cv">CV</span>
    </div>
    <nav style="display:flex;gap:10px;align-items:center;">
      <a href="index.html" class="btn btn-outline" style="font-size:.85rem;padding:7px 16px;">← Home</a>
    </nav>
  </div>
</header>


<!-- ===== MAIN LAYOUT ===== -->
<div class="builder-layout">

  <!-- ===== SIDEBAR ===== -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <h2>AI CV Tailor</h2>
      <p>3 steps to a job-ready CV</p>
    </div>

    <!-- STEP 1 — Upload CV -->
    <div class="step-section">
      <div class="step-label">
        <span class="step-num" id="step1-num">1</span>
        Upload your CV
      </div>
      <div class="upload-zone" id="upload-zone"
           onclick="document.getElementById('cv-file').click()"
           ondragover="handleDrag(event,'over')"
           ondragleave="handleDrag(event,'leave')"
           ondrop="handleDrop(event)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M4 16.5v1.5a2 2 0 002 2h12a2 2 0 002-2v-1.5M16 12l-4-4-4 4M12 8v9"/>
        </svg>
        <p id="upload-label">Click or drag a PDF / DOCX here</p>
      </div>
      <input type="file" id="cv-file" accept=".pdf,.docx" style="display:none">
    </div>

    <!-- STEP 2 — Job Description -->
    <div class="step-section">
      <div class="step-label">
        <span class="step-num" id="step2-num">2</span>
        Paste Job Description
      </div>
      <textarea id="jd-input" class="jd-textarea"
        placeholder="Paste the full job description here…"
        oninput="onJDInput()"></textarea>
      <div class="char-count"><span id="char-count">0</span> characters</div>
      <div id="kw-preview" style="display:none">
        <div style="font-size:.78rem;font-weight:600;color:var(--text-light);margin-top:10px;margin-bottom:4px;">TOP KEYWORDS DETECTED</div>
        <div class="keyword-tags" id="kw-tags"></div>
      </div>
    </div>

    <!-- STEP 3 — API Key -->
    <div class="step-section">
      <div class="step-label">
        <span class="step-num" id="step3-num">3</span>
        Your Anthropic API Key
      </div>
      <div class="api-key-wrap">
        <input type="password" id="api-key" class="api-key-input"
               placeholder="gsk_…"
               autocomplete="off"
               oninput="onApiKeyInput()">
        <button class="api-key-toggle" onclick="toggleKeyVisibility()" title="Toggle visibility">
          <svg id="eye-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
          </svg>
        </button>
      </div>
      <p class="api-key-note">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
        </svg>
        Free key from Groq — no credit card needed. Your key stays in your browser only.
        <a href="https://console.groq.com/keys" target="_blank" style="color:var(--secondary);white-space:nowrap">Get free key →</a>
      </p>
    </div>

    <!-- Error Banner -->
    <div class="error-banner" id="error-banner">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>
      </svg>
      <span id="error-text">Something went wrong.</span>
    </div>

    <!-- Generate -->
    <div class="step-section" style="border:none;padding-top:0;">
      <button id="generate-btn" class="generate-btn" onclick="generate()" disabled>
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
        </svg>
        Generate Tailored CV
      </button>
    </div>

    <div class="status-bar">
      <span class="dot" id="status-dot"></span>
      <span id="status-text">Upload a CV and paste a job description to start.</span>
    </div>

    <!-- Footer: download -->
    <div class="sidebar-footer">
      <button class="btn btn-ghost full-width" id="download-btn" onclick="downloadPDF()" disabled>
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        Download PDF
      </button>
      <button class="btn btn-ghost full-width" id="copy-btn" onclick="copyText()" disabled style="font-size:.82rem;">
        Copy Plain Text
      </button>
    </div>
  </aside>


  <!-- ===== PREVIEW PANEL ===== -->
  <main class="preview-area" id="preview-area">

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
      <div class="loading-card">
        <div class="spinner"></div>
        <h3>Crafting your CV…</h3>
        <p>Claude is reading your experience</p>
        <div class="loading-steps">
          <div class="loading-step" id="ls-parse">
            <svg class="step-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/>
            </svg>
            Parsing your CV
          </div>
          <div class="loading-step" id="ls-analyse">
            <svg class="step-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
            </svg>
            Analysing job requirements
          </div>
          <div class="loading-step" id="ls-tailor">
            <svg class="step-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/>
            </svg>
            Tailoring & rewriting
          </div>
          <div class="loading-step" id="ls-score">
            <svg class="step-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
            </svg>
            Calculating match score
          </div>
        </div>
      </div>
    </div>

    <!-- Score Badge -->
    <div class="score-badge" id="score-badge">
      <div class="score-ring">
        <svg viewBox="0 0 48 48">
          <circle class="track" cx="24" cy="24" r="20"/>
          <circle class="fill" id="score-arc" cx="24" cy="24" r="20"
                  stroke-dasharray="125.66" stroke-dashoffset="125.66"/>
        </svg>
        <div class="score-label" id="score-label">0%</div>
      </div>
      <div class="score-info">
        <div class="score-pct" id="score-pct">0%</div>
        <div class="score-sub">Match Score</div>
      </div>
    </div>

    <!-- Empty state shown before generation -->
    <div id="empty-state" class="empty-state">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
        <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
        <polyline points="14 2 14 8 20 8"/>
        <line x1="16" y1="13" x2="8" y2="13"/>
        <line x1="16" y1="17" x2="8" y2="17"/>
        <polyline points="10 9 9 9 8 9"/>
      </svg>
      <h3>Your tailored CV will appear here</h3>
      <p>Upload your existing CV, paste the job description, add your API key, then hit <strong>Generate</strong>.</p>
    </div>

    <!-- The actual CV document (hidden until generated) -->
    <div id="cv-wrapper" class="cv-wrapper" style="display:none">
      <div id="cv-document" class="a4-page">

        <!-- CV Header -->
        <div class="cv-header-section">
          <h1 id="cv-name">Full Name</h1>
          <h2 id="cv-title">Job Title</h2>
          <div class="cv-contact-info">
            <span id="cv-email"></span>
            <span id="cv-phone"></span>
            <span id="cv-location"></span>
            <span id="cv-linkedin"></span>
          </div>
        </div>

        <div class="cv-body">
          <!-- Sidebar col: skills + education -->
          <div class="cv-sidebar-col">
            <div class="cv-section">
              <div class="cv-heading">Skills</div>
              <div id="cv-skills"></div>
            </div>
            <div class="cv-section">
              <div class="cv-heading">Education</div>
              <div id="cv-education"></div>
            </div>
            <div class="cv-section" id="cv-certifications-section" style="display:none">
              <div class="cv-heading">Certifications</div>
              <div id="cv-certifications"></div>
            </div>
          </div>

          <!-- Main col: summary + experience -->
          <div class="cv-main-col">
            <div class="cv-section">
              <div class="cv-heading">Professional Summary</div>
              <p id="cv-summary" class="cv-summary-text"></p>
            </div>
            <div class="cv-section">
              <div class="cv-heading">Experience</div>
              <div id="cv-experience"></div>
            </div>
          </div>
        </div>

      </div><!-- /a4-page -->
    </div><!-- /cv-wrapper -->

  </main>
</div><!-- /builder-layout -->


<!-- ===== SCRIPTS ===== -->
<script>
// ============================================================
// CONFIG
// ============================================================
pdfjsLib.GlobalWorkerOptions.workerSrc =
  'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

const GROQ_MODEL    = 'llama-3.1-8b-instant'; // free, fast
const GROQ_API      = 'https://api.groq.com/openai/v1/chat/completions';
const MAX_CV_CHARS  = 8000;
const MAX_JD_CHARS  = 4000;

// ============================================================
// STATE
// ============================================================
let cvRawText    = '';
let hasCV        = false;
let hasJD        = false;
let hasKey       = false;
let generatedCV  = null; // parsed JSON from Claude

// ============================================================
// FILE UPLOAD
// ============================================================
document.getElementById('cv-file').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (file) await processFile(file);
});

function handleDrag(e, type) {
  e.preventDefault();
  document.getElementById('upload-zone').classList.toggle('drag-over', type === 'over');
}
function handleDrop(e) {
  e.preventDefault();
  document.getElementById('upload-zone').classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if (file) processFile(file);
}

async function processFile(file) {
  const zone  = document.getElementById('upload-zone');
  const label = document.getElementById('upload-label');

  // Validate
  if (!file.name.match(/\.(pdf|docx)$/i)) {
    showError('Only PDF and DOCX files are supported.');
    return;
  }

  label.textContent = 'Reading file…';
  try {
    if (file.name.endsWith('.pdf')) {
      cvRawText = await extractPDF(file);
    } else {
      cvRawText = await extractDocx(file);
    }
    cvRawText = cvRawText.trim().slice(0, MAX_CV_CHARS * 2); // store full for display
    hasCV = true;

    // Update UI
    zone.classList.add('has-file');
    zone.querySelector('svg').innerHTML = `
      <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
      <polyline points="22 4 12 14.01 9 11.01"/>`;
    label.innerHTML = `<span class="filename">✓ ${file.name}</span>`;
    document.getElementById('step1-num').classList.add('done');
    setStatus('CV loaded. Now paste a job description.', '');
    hideError();
    checkReady();
  } catch (err) {
    console.error(err);
    showError('Could not read the file. Try a different PDF or DOCX.');
    label.textContent = 'Click or drag a PDF / DOCX here';
  }
}

async function extractPDF(file) {
  const buf = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
  let text = '';
  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const tc   = await page.getTextContent();
    text += tc.items.map(it => it.str).join(' ') + '\n';
  }
  return text;
}

async function extractDocx(file) {
  const buf    = await file.arrayBuffer();
  const result = await mammoth.extractRawText({ arrayBuffer: buf });
  return result.value;
}

// ============================================================
// JD INPUT
// ============================================================
function onJDInput() {
  const val = document.getElementById('jd-input').value;
  document.getElementById('char-count').textContent = val.length;
  hasJD = val.trim().length > 50;

  if (hasJD) {
    document.getElementById('step2-num').classList.add('done');
    showKeywords(val);
    hideError();
  } else {
    document.getElementById('step2-num').classList.remove('done');
    document.getElementById('kw-preview').style.display = 'none';
  }
  checkReady();
}

function showKeywords(text) {
  const kws = extractTopKeywords(text, 10);
  const container = document.getElementById('kw-tags');
  container.innerHTML = kws.map(k =>
    `<span class="kw-tag ${cvRawText.toLowerCase().includes(k) ? 'match' : ''}">${k}</span>`
  ).join('');
  document.getElementById('kw-preview').style.display = 'block';
}

// ============================================================
// API KEY
// ============================================================
function onApiKeyInput() {
  const val = document.getElementById('api-key').value.trim();
  hasKey = val.startsWith('gsk_') && val.length > 20;
  if (hasKey) {
    document.getElementById('step3-num').classList.add('done');
    hideError();
  } else {
    document.getElementById('step3-num').classList.remove('done');
  }
  // Store in sessionStorage (cleared when tab closes)
  if (hasKey) sessionStorage.setItem('anthropic_key', val);
  checkReady();
}

function toggleKeyVisibility() {
  const inp  = document.getElementById('api-key');
  const icon = document.getElementById('eye-icon');
  if (inp.type === 'password') {
    inp.type = 'text';
    icon.innerHTML = `<path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19M1 1l22 22"/>`;
  } else {
    inp.type = 'password';
    icon.innerHTML = `<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>`;
  }
}

// Restore key from session on load
window.addEventListener('load', () => {
  const saved = sessionStorage.getItem('anthropic_key');
  if (saved) {
    document.getElementById('api-key').value = saved;
    onApiKeyInput();
  }
});

// ============================================================
// READY CHECK
// ============================================================
function checkReady() {
  const ready = hasCV && hasJD && hasKey;
  document.getElementById('generate-btn').disabled = !ready;
  if (ready) setStatus('Ready to generate!', 'ready');
}

// ============================================================
// GENERATION — calls Claude API
// ============================================================
async function generate() {
  hideError();
  const jd      = document.getElementById('jd-input').value.trim().slice(0, MAX_JD_CHARS);
  const cv      = cvRawText.slice(0, MAX_CV_CHARS);
  const apiKey  = document.getElementById('api-key').value.trim();

  showLoading(true);
  setLoadingStep('ls-parse', 'active');

  try {
    const prompt = buildPrompt(cv, jd);
    setLoadingStep('ls-parse', 'done');
    setLoadingStep('ls-analyse', 'active');

    const response = await callClaude(apiKey, prompt);
    setLoadingStep('ls-analyse', 'done');
    setLoadingStep('ls-tailor', 'active');

    const data = parseClaudeResponse(response);
    setLoadingStep('ls-tailor', 'done');
    setLoadingStep('ls-score', 'active');

    renderCV(data);
    renderScore(data.matchScore || 72);
    setLoadingStep('ls-score', 'done');

    generatedCV = data;
    document.getElementById('download-btn').disabled = false;
    document.getElementById('copy-btn').disabled = false;
    setStatus('CV generated successfully!', '');

  } catch (err) {
    console.error(err);
    showError(friendlyError(err));
    setStatus('Generation failed.', 'error');
  } finally {
    showLoading(false);
    resetLoadingSteps();
  }
}

// ============================================================
// CLAUDE API CALL
// ============================================================
async function callClaude(apiKey, prompt) {
  const res = await fetch(GROQ_API, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${apiKey}`,
    },
    body: JSON.stringify({
      model: GROQ_MODEL,
      max_tokens: 2048,
      temperature: 0.3,
      messages: [
        {
          role: 'system',
          content: 'You are an expert CV writer. Always respond with valid JSON only — no markdown, no code fences, no commentary.'
        },
        { role: 'user', content: prompt }
      ],
    }),
  });

  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    throw new Error(err?.error?.message || `HTTP ${res.status}`);
  }
  return res.json();
}

// ============================================================
// PROMPT BUILDER
// ============================================================
function buildPrompt(cvText, jdText) {
  return `You are an expert CV writer and recruiter. Tailor the candidate's CV to the job description below.

OUTPUT: Return ONLY a single valid JSON object — no markdown, no commentary, no code fences.

JSON SCHEMA:
{
  "name": "string",
  "email": "string",
  "phone": "string",
  "location": "string",
  "linkedin": "string",
  "targetTitle": "string — the exact job title from JD",
  "summary": "string — 3 sentences, tailored, keyword-rich",
  "skills": [
    { "name": "skill", "matched": true|false }
  ],
  "experience": [
    {
      "title": "string",
      "company": "string",
      "dates": "string",
      "bullets": ["string — rewritten to match JD, start with action verb, include metrics where possible"]
    }
  ],
  "education": [
    { "degree": "string", "school": "string", "year": "string" }
  ],
  "certifications": ["string"],
  "matchScore": number (0–100, honest assessment of CV vs JD fit),
  "missingKeywords": ["string — keywords in JD not found in CV"]
}

RULES:
- Keep ALL contact info exactly as in the CV.
- Do not invent experience or qualifications.
- Rewrite bullets to highlight relevance to the JD. Use strong action verbs and quantify where data exists.
- Mark skills as matched:true only if they appear in the JD.
- Summary must reference the company's goals if mentioned.
- matchScore: be honest. 50-65 = partial match. 66-80 = good. 81+ = excellent.

--- CANDIDATE CV ---
${cvText}

--- JOB DESCRIPTION ---
${jdText}

Return only the JSON object.`;
}

// ============================================================
// PARSE RESPONSE
// ============================================================
function parseClaudeResponse(apiResponse) {
  // Groq uses OpenAI-compatible format
  let text = apiResponse?.choices?.[0]?.message?.content || '';
  text = text.replace(/```json|```/g, '').trim();
  const start = text.indexOf('{');
  const end   = text.lastIndexOf('}');
  if (start === -1 || end === -1) throw new Error('Unexpected response format. Try again.');
  return JSON.parse(text.slice(start, end + 1));
}

// ============================================================
// RENDER CV
// ============================================================
function renderCV(d) {
  // Show CV, hide empty state
  document.getElementById('empty-state').style.display = 'none';
  document.getElementById('cv-wrapper').style.display  = 'block';

  // Header
  document.getElementById('cv-name').textContent    = d.name    || 'Full Name';
  document.getElementById('cv-title').textContent   = d.targetTitle || 'Professional';
  document.getElementById('cv-email').textContent   = d.email   || '';
  document.getElementById('cv-phone').textContent   = d.phone   || '';
  document.getElementById('cv-location').textContent= d.location|| '';

  const li = document.getElementById('cv-linkedin');
  if (d.linkedin) {
    const handle = d.linkedin.replace(/https?:\/\/(www\.)?linkedin\.com\/in\//i, '');
    li.innerHTML = `<a href="${d.linkedin}" target="_blank">linkedin.com/in/${handle}</a>`;
  } else { li.textContent = ''; }

  // Add separators between non-empty items
  ['cv-email','cv-phone','cv-location','cv-linkedin'].forEach((id, i, arr) => {
    const el = document.getElementById(id);
    el.style.display = el.textContent || el.innerHTML ? '' : 'none';
  });

  // Summary
  document.getElementById('cv-summary').textContent = d.summary || '';

  // Skills
  const skillsEl = document.getElementById('cv-skills');
  skillsEl.innerHTML = (d.skills || []).map(s =>
    `<span class="skill-pill ${s.matched ? 'matched' : ''}">${s.name}</span>`
  ).join('');

  // Experience
  const expEl = document.getElementById('cv-experience');
  expEl.innerHTML = '';
  (d.experience || []).forEach(job => {
    const div = document.createElement('div');
    div.className = 'cv-item';
    div.innerHTML = `
      <div class="cv-item-header">
        <span class="cv-item-title">${esc(job.title)}</span>
        <span class="cv-item-date">${esc(job.dates || '')}</span>
      </div>
      <div class="cv-item-subtitle">${esc(job.company || '')}</div>
      <ul>${(job.bullets || []).map(b => `<li>${esc(b)}</li>`).join('')}</ul>
    `;
    expEl.appendChild(div);
  });

  // Education
  const eduEl = document.getElementById('cv-education');
  eduEl.innerHTML = '';
  (d.education || []).forEach(e => {
    const div = document.createElement('div');
    div.style.marginBottom = '10px';
    div.innerHTML = `
      <div style="font-weight:700;font-size:.88rem;">${esc(e.degree || '')}</div>
      <div style="font-size:.82rem;color:var(--text-light)">${esc(e.school || '')}</div>
      <div style="font-size:.78rem;color:var(--text-light)">${esc(e.year || '')}</div>
    `;
    eduEl.appendChild(div);
  });

  // Certifications
  const certs = d.certifications || [];
  if (certs.length) {
    document.getElementById('cv-certifications-section').style.display = '';
    document.getElementById('cv-certifications').innerHTML =
      certs.map(c => `<div style="font-size:.82rem;margin-bottom:4px;">• ${esc(c)}</div>`).join('');
  }

  // Scale to fit viewport
  scaleCV();
}

function scaleCV() {
  const wrapper = document.getElementById('cv-wrapper');
  const preview = document.getElementById('preview-area');
  const availW  = preview.clientWidth - 48;
  const scale   = Math.min(1, availW / 794);
  wrapper.style.transform = `scale(${scale})`;
  wrapper.style.marginBottom = `-${794 * (1 - scale) * 0.2}px`; // compensate whitespace
}
window.addEventListener('resize', scaleCV);

// ============================================================
// RENDER SCORE
// ============================================================
function renderScore(pct) {
  const arc        = document.getElementById('score-arc');
  const circumf    = 125.66;
  const offset     = circumf - (circumf * pct / 100);
  arc.style.strokeDashoffset = offset;
  arc.className    = `fill${pct >= 75 ? '' : pct >= 55 ? ' mid' : ' low'}`;

  document.getElementById('score-label').textContent = `${pct}%`;
  document.getElementById('score-pct').textContent   = `${pct}%`;
  document.getElementById('score-badge').classList.add('visible');
}

// ============================================================
// PDF DOWNLOAD
// ============================================================
async function downloadPDF() {
  const btn = document.getElementById('download-btn');
  btn.textContent = 'Generating…';
  btn.disabled = true;

  // Temporarily reset transform for accurate capture
  const wrapper = document.getElementById('cv-wrapper');
  const prevTransform = wrapper.style.transform;
  wrapper.style.transform = 'none';

  const element = document.getElementById('cv-document');
  const name    = (generatedCV?.name || 'CV').replace(/\s+/g, '_');

  await html2pdf()
    .set({
      margin: 0,
      filename: `${name}_Tailored_CV.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true, logging: false },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
    })
    .from(element)
    .save();

  wrapper.style.transform = prevTransform;
  btn.innerHTML = `<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> Download PDF`;
  btn.disabled = false;
}

// ============================================================
// COPY PLAIN TEXT
// ============================================================
function copyText() {
  if (!generatedCV) return;
  const d = generatedCV;
  let text = `${d.name}\n${d.targetTitle}\n${d.email} | ${d.phone} | ${d.location}\n\n`;
  text += `SUMMARY\n${d.summary}\n\n`;
  text += `SKILLS\n${(d.skills||[]).map(s=>s.name).join(', ')}\n\n`;
  text += `EXPERIENCE\n`;
  (d.experience||[]).forEach(j => {
    text += `${j.title} — ${j.company} (${j.dates})\n`;
    (j.bullets||[]).forEach(b => text += `  • ${b}\n`);
    text += '\n';
  });
  text += `EDUCATION\n`;
  (d.education||[]).forEach(e => text += `${e.degree}, ${e.school} (${e.year})\n`);

  navigator.clipboard.writeText(text).then(() => {
    const btn = document.getElementById('copy-btn');
    btn.textContent = '✓ Copied!';
    setTimeout(() => btn.textContent = 'Copy Plain Text', 2000);
  });
}

// ============================================================
// UI HELPERS
// ============================================================
function setStatus(msg, type) {
  document.getElementById('status-text').textContent = msg;
  const dot = document.getElementById('status-dot');
  dot.className = `dot ${type === 'error' ? 'error' : type === 'loading' ? 'loading' : ''}`;
}

function showError(msg) {
  const banner = document.getElementById('error-banner');
  document.getElementById('error-text').textContent = msg;
  banner.classList.add('visible');
}
function hideError() {
  document.getElementById('error-banner').classList.remove('visible');
}

function showLoading(show) {
  document.getElementById('loading-overlay').classList.toggle('visible', show);
  document.getElementById('generate-btn').disabled = show;
  if (show) setStatus('Generating…', 'loading');
}

function setLoadingStep(id, state) {
  const el = document.getElementById(id);
  if (!el) return;
  el.className = `loading-step ${state}`;
  if (state === 'done') {
    el.querySelector('svg').innerHTML = `<polyline points="20 6 9 17 4 12"/>`;
  }
}
function resetLoadingSteps() {
  ['ls-parse','ls-analyse','ls-tailor','ls-score'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.className = 'loading-step';
  });
}

function friendlyError(err) {
  const msg = err.message || '';
  if (msg.includes('401') || msg.includes('authentication') || msg.includes('Unauthorized'))
    return 'Invalid API key. Check your Groq key at console.groq.com and try again.';
  if (msg.includes('429') || msg.includes('rate'))
    return 'Rate limit reached. Groq free tier allows 14,400 req/day — wait a moment and retry.';
  if (msg.includes('400'))
    return 'Bad request — your CV or JD may be too long. Try trimming them.';
  if (msg.includes('unexpected format'))
    return msg;
  return `Error: ${msg}. Please try again.`;
}

function esc(str) {
  return String(str)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;');
}

// ============================================================
// KEYWORD EXTRACTION (client-side for preview)
// ============================================================
function extractTopKeywords(text, n = 10) {
  const stopWords = new Set(['the','and','to','of','a','in','for','with','on','is','as','an','at','by',
    'be','are','that','or','it','from','this','will','we','you','our','your','have','has','their',
    'they','who','which','about','can','would','should','must','able','experience','skills','work']);
  const freq = {};
  text.toLowerCase().replace(/[^\w\s]/g,'').split(/\s+/).forEach(w => {
    if (w.length > 3 && !stopWords.has(w)) freq[w] = (freq[w] || 0) + 1;
  });
  return Object.entries(freq).sort((a,b) => b[1]-a[1]).slice(0,n).map(e => e[0]);
}
</script>

</body>
</html>
